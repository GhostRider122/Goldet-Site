<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Panel | Goldet</title>
<link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet"/>
<style>
  *{box-sizing:border-box}
  body,html{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,#f4d7a6,#e5b34a);color:#3b2d10}
  .sidebar{position:fixed;left:0;top:0;width:220px;height:100vh;background:#b86b00;padding:18px;color:white;display:flex;flex-direction:column}
  .logo{font-family:'Titan One',cursive;font-size:34px;margin-bottom:18px}
  .sidebar a{color:white;text-decoration:none;margin:8px 0;display:block;padding:8px;border-radius:6px}
  .main{margin-left:220px;padding:22px;height:100vh;overflow-y:auto}
  h1{font-family:'Titan One',cursive}
  .panel{background:#fff8e2;padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.08);margin-bottom:14px}
  .request{background:rgba(0,0,0,0.03);padding:10px;border-radius:8px;margin-bottom:10px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;margin-right:8px}
  .btn.approve{background:#27ae60;color:white}
  .btn.decline{background:#e67e22;color:white}
  .btn.save{background:#fff3e0;color:#a75c00}
  .btn.delete{background:#c0392b;color:white}
  .user-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="number"]{padding:6px;border-radius:6px;border:1px solid #d1af6a}
</style>
</head>
<body>

<div class="sidebar">
  <div class="logo">GOLDET</div>
  <a href="dashboard.html">üè† Dashboard</a>
  <a href="chat.html">üí¨ Chat</a>
  <a href="logout.html">üîí Logout</a>
</div>

<div class="main">
  <h1>Admin Panel</h1>

  <div class="panel" id="pendingPanel">
    <h3>Pending Signup Requests</h3>
    <div id="pendingList">Loading pending requests...</div>
  </div>

  <div class="panel" id="usersPanel">
    <h3>All Registered Users</h3>
    <div id="usersList">Loading users...</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
<script>
  /***** REPLACE with your Goldet Firebase config *****/
  const firebaseConfig = {
    apiKey: "REPLACE_WITH_YOUR_API_KEY",
    authDomain: "REPLACE_WITH_AUTHDOMAIN",
    databaseURL: "https://REPLACE_WITH_DB.firebaseio.com",
    projectId: "REPLACE_PROJECT_ID",
    storageBucket: "REPLACE_BUCKET",
    messagingSenderId: "REPLACE_SENDER_ID",
    appId: "REPLACE_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Configure allowed admin usernames
  const allowedAdmins = ["GoldetOwner","AdminMaster","YourUsernameHere"];

  // Simple helper: get current logged local user
  const current = localStorage.getItem('goldetCurrentUser');

  // Check admin access by reading /users/current from DB
  async function checkAdminAccess() {
    if (!current) {
      alert('Not logged in as admin. Redirecting to login.');
      location.href = 'login.html';
      return false;
    }
    const snap = await db.ref('users/' + current).get();
    if (!snap.exists()) {
      alert('Account not found. Redirecting to login.');
      location.href = 'login.html';
      return false;
    }
    const data = snap.val();
    if (!allowedAdmins.includes(data.username)) {
      alert('Access denied.');
      location.href = 'dashboard.html';
      return false;
    }
    return true;
  }

  // Render pending signup requests (forms)
  function renderPending(dataObj) {
    const container = document.getElementById('pendingList');
    container.innerHTML = '';
    const entries = Object.entries(dataObj || {});
    let any = false;
    entries.forEach(([username, form]) => {
      if (!form || form.status !== 'pending') return;
      any = true;
      const div = document.createElement('div');
      div.className = 'request';
      div.innerHTML = `
        <b>${username}</b><br>
        Age: ${form.age || 'N/A'}<br>
        Discord: ${form.discord || 'N/A'}<br>
        Reason: ${form.whyPlay || 'N/A'}<br>
        <div style="margin-top:8px">
          <button class="btn approve" onclick="approveUser('${username}','${form.password}')">Approve</button>
          <button class="btn decline" onclick="declineUser('${username}')">Decline</button>
        </div>
      `;
      container.appendChild(div);
    });
    if (!any) container.innerHTML = '<i>No pending requests.</i>';
  }

  // Approve: create users/{username} with initial data, set forms/{username}/status='approved'
  window.approveUser = async (username, hashed) => {
    const userRef = db.ref('users/' + username);
    await userRef.set({
      username,
      password: hashed,
      tokens: 0,
      goldsUnlocked: 0,
      packsOpened: 0,
      messagesSent: 0,
      friends: [],
      friendRequests: [],
      isAdmin: allowedAdmins.includes(username),
      approved: true,
      rank: 'New Player',
      createdAt: Date.now()
    });
    // mark form approved
    await db.ref('forms/' + username + '/status').set('approved');
    alert(username + ' approved.');
    loadPendingOnce();
    loadUsersOnce();
  };

  window.declineUser = async (username) => {
    await db.ref('forms/' + username + '/status').set('declined');
    alert(username + ' declined.');
    loadPendingOnce();
  };

  // Load pending forms once
  async function loadPendingOnce() {
    const snap = await db.ref('forms').get();
    renderPending(snap.val() || {});
  }

  // Render all users with edit fields
  function renderUsers(usersObj) {
    const container = document.getElementById('usersList');
    container.innerHTML = '';
    const entries = Object.entries(usersObj || {});
    if (!entries.length) { container.innerHTML = '<i>No users registered yet.</i>'; return; }
    entries.forEach(([username, data]) => {
      const div = document.createElement('div');
      div.className = 'user-row';
      div.style.marginBottom = '12px';
      div.innerHTML = `
        <div style="flex:1;min-width:220px" >
          <b>${username}</b><br>
          Email: <input type="text" id="email-${username}" value="${data.email || ''}" /><br>
        </div>
        <div>
          Tokens:<br><input type="number" id="tokens-${username}" value="${data.tokens||0}" />
        </div>
        <div>
          Golds:<br><input type="number" id="golds-${username}" value="${data.goldsUnlocked||0}" />
        </div>
        <div>
          Packs:<br><input type="number" id="packs-${username}" value="${data.packsOpened||0}" />
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn save" onclick="saveUser('${username}')">Save</button>
          <button class="btn delete" onclick="deleteUser('${username}')">Delete</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  window.saveUser = async (username) => {
    const tokens = Number(document.getElementById('tokens-'+username).value || 0);
    const golds = Number(document.getElementById('golds-'+username).value || 0);
    const packs = Number(document.getElementById('packs-'+username).value || 0);

    await db.ref('users/' + username).update({
      tokens, goldsUnlocked: golds, packsOpened: packs
    });
    alert('Saved ' + username);
    loadUsersOnce();
  };

  window.deleteUser = async (username) => {
    if(!confirm('Delete user '+username+'?')) return;
    await db.ref('users/' + username).remove();
    alert('Deleted ' + username);
    loadUsersOnce();
  };

  async function loadUsersOnce() {
    const snap = await db.ref('users').get();
    renderUsers(snap.val() || {});
  }

  (async function init() {
    const ok = await checkAdminAccess();
    if (!ok) return;
    // initial loads
    loadPendingOnce();
    loadUsersOnce();

    // realtime listeners (optional)
    db.ref('forms').on('value', snap => renderPending(snap.val() || {}));
    db.ref('users').on('value', snap => renderUsers(snap.val() || {}));
  })();
</script>
</body>
</html>
