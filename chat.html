<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Goldet â€” Chat</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
<script src="firebase.js"></script>

<div class="dashboard-page">
  <nav class="sidebar">
    <div class="logo">Goldet</div>
    <div class="side-link" onclick="location.href='dashboard.html'">ğŸ† Stats</div>
    <div class="side-link" onclick="location.href='chat.html'">ğŸ’¬ Chat</div>
    <div class="side-link" onclick="location.href='dashboard.html'">ğŸ”™ Back</div>
  </nav>

  <main class="main-area">
    <div class="top-userbar">
      <div class="user-card"><h2>Global Chat</h2></div>
    </div>

    <section class="stats-box">
      <div id="messagesList" style="max-height:60vh;overflow:auto;padding:8px"></div>
    </section>

    <div style="display:flex;gap:8px">
      <input id="msgInput" placeholder="Say something..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #d1af6a"/>
      <button id="sendBtn" class="btn primary">Send</button>
    </div>

  </main>
</div>

<script>
document.addEventListener('GoldetDBReady', ()=> {
  const db = GoldetDB.db;
  const current = GoldetDB.sessionGet();
  if(!current) { window.location.href='login.html'; return; }

  const messagesList = document.getElementById('messagesList');
  const messagesRef = db.ref('messages');

  // load and listen
  messagesRef.limitToLast(200).on('value', snap => {
    messagesList.innerHTML = '';
    const v = snap.val() || {};
    const arr = Object.entries(v).sort((a,b)=> (a[1].timestamp||0)-(b[1].timestamp||0));
    arr.forEach(([id,msg])=>{
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<strong>${msg.username}</strong> <span style="color:#7a6534;font-size:12px"> â€” ${new Date(msg.timestamp||0).toLocaleString()}</span><div>${msg.text}</div>`;
      messagesList.appendChild(div);
    });
    messagesList.scrollTop = messagesList.scrollHeight;
  });

  document.getElementById('sendBtn').addEventListener('click', async () => {
    const text = document.getElementById('msgInput').value.trim();
    if(!text) return;
    const msgObj = { username: current, text, timestamp: Date.now() };
    await messagesRef.push(msgObj);

    // increment messagesSent stat
    const userRef = db.ref('users/' + current);
    const uSnap = await userRef.get();
    if(uSnap.exists()) {
      const user = uSnap.val();
      await userRef.update({ messagesSent: (user.messagesSent||0) + 1 });
    }
    document.getElementById('msgInput').value = '';
  });

});
</script>
</body>
</html>
