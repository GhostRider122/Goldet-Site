<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Goldet â€” Dashboard</title>
  <link rel="stylesheet" href="styles.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
  <script src="firebase.js"></script>

  <div class="dashboard-page">
    <nav class="sidebar">
      <div class="logo">Goldet</div>
      <div class="side-link" onclick="location.href='dashboard.html'">ğŸ† Stats</div>
      <div class="side-link" onclick="location.href='leaderboard.html'">ğŸ“‹ Leaderboard</div>
      <div class="side-link" onclick="location.href='chat.html'">ğŸ’¬ Chat</div>
      <div class="side-link" onclick="location.href='clans.html'">ğŸ‘¥ Clans</div>
      <div class="side-link" onclick="location.href='market.html'">ğŸ›’ Market</div>
      <div class="side-link" onclick="location.href='inventory.html'">ğŸ“¦ Inventory</div>
      <div class="side-link" onclick="location.href='admin.html'">ğŸ”‘ Admin</div>
      <div class="side-link" onclick="location.href='logout.html'">ğŸ”’ Logout</div>
    </nav>

    <main class="main-area">
      <div class="top-userbar">
        <div class="user-card">
          <div>
            <h2 id="usernameField">User</h2>
            <div style="font-size:13px;color:#7a6534" id="rankField">New Player</div>
          </div>
        </div>
        <div>
          <button class="btn primary" id="openPackBtn">Open Pack</button>
        </div>
      </div>

      <section class="stats-box">
        <div class="stats-row">
          <div class="stat-card">
            <div class="label">Tokens</div>
            <div class="value" id="tokens">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Golds Unlocked</div>
            <div class="value" id="goldsUnlocked">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Packs Opened</div>
            <div class="value" id="packsOpened">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Messages Sent</div>
            <div class="value" id="messagesSent">0</div>
          </div>
        </div>
      </section>

      <section class="friends-section">
        <div class="friends-title">Friends</div>
        <div id="friendsList"><p style="color:#7a6534;">You have no friends added yet.</p></div>
      </section>

    </main>
  </div>

  <script>
  // dashboard.js inlined for simplicity
  document.addEventListener('GoldetDBReady', ()=> {
    const db = GoldetDB.db;
    const session = GoldetDB.sessionGet();
    if(!session) { window.location.href='login.html'; return; }

    async function loadUser(){
      const data = await GoldetDB.getUserOnce(session);
      if(!data){ alert('User record not found.'); GoldetDB.sessionClear(); window.location.href='login.html'; return; }
      document.getElementById('usernameField').textContent = data.username || session;
      document.getElementById('rankField').textContent = data.rank || 'New Player';
      document.getElementById('tokens').textContent = data.tokens ?? 0;
      document.getElementById('goldsUnlocked').textContent = data.goldsUnlocked ?? 0;
      document.getElementById('packsOpened').textContent = data.packsOpened ?? 0;
      document.getElementById('messagesSent').textContent = data.messagesSent ?? 0;

      // friends render
      const friendsContainer = document.getElementById('friendsList');
      friendsContainer.innerHTML = '';
      if(data.friends && data.friends.length){
        for(const uid of data.friends){
          const snap = await db.ref('users/' + uid).get();
          const d = snap.exists()? snap.val() : {username: uid};
          const div = document.createElement('div');
          div.className = 'friend-item';
          div.innerHTML = `<div class="friend-pfp"></div><span>${d.username}</span>`;
          div.addEventListener('click', ()=> alert('View ' + d.username + ' stats coming soon'));
          friendsContainer.appendChild(div);
        }
      } else friendsContainer.innerHTML = `<p style="color:#7a6534;">You have no friends added yet.</p>`;
    }

    loadUser();

    // realtime updates for user's node
    db.ref('users/' + session).on('value', snap => {
      if(!snap.exists()) return;
      const d = snap.val();
      document.getElementById('tokens').textContent = d.tokens ?? 0;
      document.getElementById('goldsUnlocked').textContent = d.goldsUnlocked ?? 0;
      document.getElementById('packsOpened').textContent = d.packsOpened ?? 0;
      document.getElementById('messagesSent').textContent = d.messagesSent ?? 0;
    });

    // pack opening example: increments packsOpened & goldsUnlocked & reduces tokens
    document.getElementById('openPackBtn').addEventListener('click', async ()=> {
      const userRef = db.ref('users/' + session);
      const snap = await userRef.get();
      if(!snap.exists()) return;
      const user = snap.val();
      if((user.tokens||0) < 50) { alert('Not enough tokens (pack cost 50).'); return; }
      const newTokens = (user.tokens||0) - 50;
      // simple deterministic gold unlock
      const newGolds = (user.goldsUnlocked||0) + 1;
      const newPacks = (user.packsOpened||0) + 1;
      await userRef.update({ tokens: newTokens, goldsUnlocked: newGolds, packsOpened: newPacks });
      alert('Opened a pack! You earned 1 gold.');
    });

  });
  </script>
</body>
</html>
